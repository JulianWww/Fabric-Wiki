name: "Build Release"
on: 
  workflow_dispatch:
  release:
    types: [published]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - { uses: actions/checkout@v2, with: { fetch-depth: 0 } }
      - {
          name: "Set up JDK 17",
          uses: actions/setup-java@v2,
          with: { distribution: "adopt", java-version: "17" },
        }
      - {
          uses: madhead/read-java-properties@latest,
          id: all,
          with: {
            file: gradle.properties,
            all: true
          }
        }
      - {
          name: "Build with Gradle",
          id: build,
          run: "chmod +x gradlew && ./gradlew build publish",
        }
      - name: "Publish maven to wandhoven.ddns.net"
        uses: appleboy/scp-action@master
        with:
          host: "wandhoven.ddns.net"
          username: ${{ secrets.SCP_MAVEN_USERNAME }}
          key: ${{ secrets.SCP_MAVENKEY }}
          source: "maven/"
          target: "/media/B/html/"
          
      - name: "Upload to CurseForge"
        if: ${{ steps.all.outputs.dev }} == "_false"
        uses: itsmeow/curseforge-upload@v3
        with:
          file_path: "build/libs/BlockHighlighting-${{ steps.all.outputs.minecraft_version }}-${{ steps.build.outputs.version }}.jar"
          game_endpoint: "minecraft"
          relations: "fabric-api:requiredDependency"
          game_versions: "Minecraft {{ steps.build.outputs.minecraft_version }},Java 17,Fabric"
          project_id: "841454"
          token: "${{ secrets.CF_API_TOKEN }}"
          release_type: "${{ steps.build.outputs.type }}"
